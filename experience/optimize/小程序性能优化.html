<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>小程序性能优化 | 罗湖</title>
    <meta name="description" content="不如意事常八九，可与言者无二三">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="icon" href="/favicon.ico">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.2a8ad169.css" as="style"><link rel="preload" href="/assets/js/app.7432f3e5.js" as="script"><link rel="preload" href="/assets/js/2.5aced2d4.js" as="script"><link rel="preload" href="/assets/js/27.2a3cfa74.js" as="script"><link rel="prefetch" href="/assets/js/10.ad3ba127.js"><link rel="prefetch" href="/assets/js/11.e9d40382.js"><link rel="prefetch" href="/assets/js/12.c895aa41.js"><link rel="prefetch" href="/assets/js/13.d94d6e78.js"><link rel="prefetch" href="/assets/js/14.5b7e352e.js"><link rel="prefetch" href="/assets/js/15.541c6e8a.js"><link rel="prefetch" href="/assets/js/16.32c2d9b5.js"><link rel="prefetch" href="/assets/js/17.7a92153c.js"><link rel="prefetch" href="/assets/js/18.444ff785.js"><link rel="prefetch" href="/assets/js/19.c3f37e80.js"><link rel="prefetch" href="/assets/js/20.e16c3ba3.js"><link rel="prefetch" href="/assets/js/21.9ddfd863.js"><link rel="prefetch" href="/assets/js/22.961432bc.js"><link rel="prefetch" href="/assets/js/23.27fdba8d.js"><link rel="prefetch" href="/assets/js/24.97447734.js"><link rel="prefetch" href="/assets/js/25.39c264e0.js"><link rel="prefetch" href="/assets/js/26.6a36b440.js"><link rel="prefetch" href="/assets/js/28.bb6fa8ab.js"><link rel="prefetch" href="/assets/js/29.c29c1bab.js"><link rel="prefetch" href="/assets/js/3.6b4fff62.js"><link rel="prefetch" href="/assets/js/30.f0fe177b.js"><link rel="prefetch" href="/assets/js/31.726ce2a1.js"><link rel="prefetch" href="/assets/js/32.c76004bd.js"><link rel="prefetch" href="/assets/js/33.318b7970.js"><link rel="prefetch" href="/assets/js/34.17f63915.js"><link rel="prefetch" href="/assets/js/35.3d6782f1.js"><link rel="prefetch" href="/assets/js/36.a1aee197.js"><link rel="prefetch" href="/assets/js/37.b0c74960.js"><link rel="prefetch" href="/assets/js/38.48bbe4a6.js"><link rel="prefetch" href="/assets/js/39.0cca90a4.js"><link rel="prefetch" href="/assets/js/4.7a4d83b2.js"><link rel="prefetch" href="/assets/js/40.2bed5538.js"><link rel="prefetch" href="/assets/js/41.adbc1770.js"><link rel="prefetch" href="/assets/js/42.1210e1c5.js"><link rel="prefetch" href="/assets/js/43.44c5242f.js"><link rel="prefetch" href="/assets/js/44.08bd0ca2.js"><link rel="prefetch" href="/assets/js/45.2d20f3de.js"><link rel="prefetch" href="/assets/js/46.a294339c.js"><link rel="prefetch" href="/assets/js/47.1ec4fce2.js"><link rel="prefetch" href="/assets/js/48.c0f89a67.js"><link rel="prefetch" href="/assets/js/49.4f8db54b.js"><link rel="prefetch" href="/assets/js/5.6e68c4f5.js"><link rel="prefetch" href="/assets/js/50.15f84966.js"><link rel="prefetch" href="/assets/js/51.ae6081da.js"><link rel="prefetch" href="/assets/js/52.f5fe5324.js"><link rel="prefetch" href="/assets/js/53.db0f30d7.js"><link rel="prefetch" href="/assets/js/54.0093e258.js"><link rel="prefetch" href="/assets/js/55.28c8cfb7.js"><link rel="prefetch" href="/assets/js/56.3648c491.js"><link rel="prefetch" href="/assets/js/57.67064559.js"><link rel="prefetch" href="/assets/js/58.6dda11c1.js"><link rel="prefetch" href="/assets/js/59.5dc6023a.js"><link rel="prefetch" href="/assets/js/6.36295da7.js"><link rel="prefetch" href="/assets/js/60.e58d100a.js"><link rel="prefetch" href="/assets/js/61.d209e777.js"><link rel="prefetch" href="/assets/js/62.32b552f9.js"><link rel="prefetch" href="/assets/js/63.5a9880dc.js"><link rel="prefetch" href="/assets/js/64.a01212d2.js"><link rel="prefetch" href="/assets/js/65.ad2ddb81.js"><link rel="prefetch" href="/assets/js/66.0493200f.js"><link rel="prefetch" href="/assets/js/67.6b094279.js"><link rel="prefetch" href="/assets/js/68.3ade9e58.js"><link rel="prefetch" href="/assets/js/69.3d974bc3.js"><link rel="prefetch" href="/assets/js/7.dd509bad.js"><link rel="prefetch" href="/assets/js/70.bda6a43e.js"><link rel="prefetch" href="/assets/js/71.78d92800.js"><link rel="prefetch" href="/assets/js/72.730c0373.js"><link rel="prefetch" href="/assets/js/73.4a2dd28a.js"><link rel="prefetch" href="/assets/js/8.520393bc.js"><link rel="prefetch" href="/assets/js/9.e4989b40.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2a8ad169.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/profile.png" alt="罗湖" class="logo"> <span class="site-name can-hide">罗湖</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/js/" class="nav-link">
  js
</a></div><div class="nav-item"><a href="/css/" class="nav-link">
  css
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发经验" class="dropdown-title"><span class="title">开发经验</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/experience/tool/" class="nav-link">
  工具
</a></li><li class="dropdown-item"><!----> <a href="/experience/exception/" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/experience/engineering/" class="nav-link">
  工程化
</a></li><li class="dropdown-item"><!----> <a href="/experience/optimize/" class="nav-link router-link-active">
  优化
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="设计模式" class="dropdown-title"><span class="title">设计模式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pattern/basic/" class="nav-link">
  基础知识
</a></li><li class="dropdown-item"><!----> <a href="/pattern/core/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/pattern/skill/" class="nav-link">
  设计原则与编程技巧
</a></li></ul></div></div><div class="nav-item"><a href="/progress/" class="nav-link">
  修身
</a></div><div class="nav-item"><a href="/career/" class="nav-link">
  职业
</a></div> <a href="https://github.com/lanbling/document" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/js/" class="nav-link">
  js
</a></div><div class="nav-item"><a href="/css/" class="nav-link">
  css
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  node
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发经验" class="dropdown-title"><span class="title">开发经验</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/experience/tool/" class="nav-link">
  工具
</a></li><li class="dropdown-item"><!----> <a href="/experience/exception/" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/experience/engineering/" class="nav-link">
  工程化
</a></li><li class="dropdown-item"><!----> <a href="/experience/optimize/" class="nav-link router-link-active">
  优化
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="设计模式" class="dropdown-title"><span class="title">设计模式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pattern/basic/" class="nav-link">
  基础知识
</a></li><li class="dropdown-item"><!----> <a href="/pattern/core/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/pattern/skill/" class="nav-link">
  设计原则与编程技巧
</a></li></ul></div></div><div class="nav-item"><a href="/progress/" class="nav-link">
  修身
</a></div><div class="nav-item"><a href="/career/" class="nav-link">
  职业
</a></div> <a href="https://github.com/lanbling/document" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/experience/tool/" class="sidebar-heading clickable"><span>工具</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/experience/exception/" class="sidebar-heading clickable"><span>异常</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/experience/engineering" class="sidebar-heading clickable"><span>工程化</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/experience/optimize" class="sidebar-heading clickable router-link-active open"><span>优化</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/experience/optimize/小程序性能优化.html" class="active sidebar-link">小程序性能优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/experience/optimize/小程序性能优化.html#小程序官方性能指标" class="sidebar-link">小程序官方性能指标</a></li><li class="sidebar-sub-header"><a href="/experience/optimize/小程序性能优化.html#小程序底层架构" class="sidebar-link">小程序底层架构</a></li><li class="sidebar-sub-header"><a href="/experience/optimize/小程序性能优化.html#小程序启动慢" class="sidebar-link">小程序启动慢</a></li><li class="sidebar-sub-header"><a href="/experience/optimize/小程序性能优化.html#白屏时间长" class="sidebar-link">白屏时间长</a></li><li class="sidebar-sub-header"><a href="/experience/optimize/小程序性能优化.html#页面渲染慢" class="sidebar-link">页面渲染慢</a></li><li class="sidebar-sub-header"><a href="/experience/optimize/小程序性能优化.html#运行内存不足" class="sidebar-link">运行内存不足</a></li><li class="sidebar-sub-header"><a href="/experience/optimize/小程序性能优化.html#小程序生命周期" class="sidebar-link">小程序生命周期</a></li><li class="sidebar-sub-header"><a href="/experience/optimize/小程序性能优化.html#原文链接" class="sidebar-link">原文链接</a></li></ul></li><li><a href="/experience/optimize/H5视频播放踩坑.html" class="sidebar-link">H5视频播放踩坑</a></li><li><a href="/experience/optimize/SEO.html" class="sidebar-link">SEO</a></li><li><a href="/experience/optimize/Vue项目优化打包体积和首屏加载.html" class="sidebar-link">Vue项目优化打包体积和首屏加载</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="小程序性能优化"><a href="#小程序性能优化" class="header-anchor">#</a> 小程序性能优化</h1> <h2 id="小程序官方性能指标"><a href="#小程序官方性能指标" class="header-anchor">#</a> 小程序官方性能指标</h2> <ul><li>首屏时间不超过5秒</li> <li>渲染时间不超过500ms</li> <li>每秒调用setData的次数不超过20次</li> <li>setData的数据在JSON.stringfy后不超过256kb</li> <li>页面WXML节点少于1000个，节点树深度少于30层，子节点树不大于60个</li> <li>所有网络请求都在1内返回结果</li></ul> <h2 id="小程序底层架构"><a href="#小程序底层架构" class="header-anchor">#</a> 小程序底层架构</h2> <p>对于传统的网页来说，UI渲染和JS脚本是在同一个线程中进行，所以经常会出现“阻塞”行为。微信小程序基于性能的考虑，启用了双线程模型：</p> <ul><li><p>视图层：也就是webview线程，负责启用不同的webview来渲染不同的小程序页面；</p></li> <li><p>逻辑层：一个单独的线程执行JS代码，可以控制视图层的逻辑。<img src="http://image.lanbling.com/md/06dee7fb8293b482.png" alt="06dee7fb8293b482"></p> <p>然而，任何线程间的数据传输都是有延时的，这意味着逻辑层和视图层间通信是异步行为。除此之外，微信为小程序提供了很多客户端原生能力，在调用客户端原生能力的过程中，微信主线程和小程序双线程之间也会发生通信，这也是一种异步行为。</p> <p>常见的几个问题：</p> <ul><li>小程序启动慢</li> <li>白屏时间长</li> <li>页面渲染慢</li> <li>运行内存不足</li></ul></li></ul> <h2 id="小程序启动慢"><a href="#小程序启动慢" class="header-anchor">#</a> 小程序启动慢</h2> <p>在这个阶段，微信会完成几项工作：</p> <ol><li>准备运行环境</li> <li>下载小程序代码包</li> <li>加载小程序代码包</li> <li>初始化小程序首页</li></ol> <p>优化策略：</p> <ol><li><p>无用文件、函数、样式剔除</p></li> <li><p>减少代码包中的静态资源文件</p> <p>小程序代码包最终会经过GZIP压缩后放在CDN上，但是GZIP压缩对图片资源来说效果很低。如JPG、PNG等格式文件，本身就已经被压缩过，再用GZIP压缩有可能体积更大。建议开发者把图片、视频等静态资源都放在CDN上。</p> <p>Base64本质上是长字符串，和CDN地址比起来会更占空间。</p></li> <li><p>逻辑后移，精简业务代码</p> <p>不涉及前端计算的展示类逻辑，都可以适当做后移。</p></li> <li><p><strong>复用模板插件</strong></p></li> <li><p>分包加载</p></li> <li><p>部分页面h5化</p> <p>小程序提供了web-view组件。</p> <p>小程序和h5通信可以通过JSSDK或postMessage通道来实现，详见<a href="https://developers.weixin.qq.com/miniprogram/dev/component/web-view.html" target="_blank" rel="noopener noreferrer">小程序开发文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>;</p></li></ol> <h2 id="白屏时间长"><a href="#白屏时间长" class="header-anchor">#</a> 白屏时间长</h2> <p>影响白屏加载时间：</p> <ul><li>网络资源加载时间</li> <li>渲染时间</li></ul> <p>优化策略：</p> <ol><li><p>启用本地缓存</p> <p>并非所有场景都适合缓存策略，譬如对数据即时性要求非常高的场景（如抢购入口）。</p></li> <li><p>数据预拉取</p> <p>小程序冷启动时，微信服务器代理小程序客户端发起一个HTTP请求到第三方服务器来获取数据，并且把响应数据存储在本地客户端供小程序前端调用。当小程序加载完成后，只需要调用微信提供的API wx.getBackgroundFetchData 从本地缓存获取数据即可。这种做法可以充分利用小程序启动和初始化阶段的等待时间，使更快地完成页面渲染。</p> <p>缺点：</p> <ul><li>预拉取数据强缓存30分钟，对于数据实时性高的系统来说非常致命</li> <li>微信服务器发起的请求没有提供区分线上版本和开发版的参数，且没有提供用户IP等信息。</li></ul></li> <li><p><strong>跳转时预拉取</strong></p></li> <li><p>分包预加载</p> <p>开启了分包加载，在用户访问到包内某个页面时，小程序才会开始下载对应的分包。等待时，页面会维持“白屏”转态。</p> <p>小程序提供了分包预下载能力，开发者可以配置进入某个页面时下载可能用到的分包。</p></li> <li><p>非关键渲染数据延迟请求</p> <p>页面结构划分成两类：主体模块和非主体模块。</p> <p>在初始化首页时，小程序会发起一个聚合接口请求来获取主体模块的数据，而非主体模块的数据则从另一个接口获取。通过拆分的手段来降低主接口的调用时延，同时减少响应体的数据量，减少网络传输时间。</p></li> <li><p>分屏渲染</p> <p>接着上面的第5步骤。当小程序获取到主体模块的数据后，会优先渲染首屏模块，在所有首屏模块都渲染完成后才会想渲染非首屏模块和非主体模块，以此确保首屏内容以最快速度呈现。</p></li> <li><p>接口聚合，请求合并</p></li> <li><p>图片资源优化</p> <ul><li><p>使用WebP格式，在肉眼无差别的图片质量前提下具有更小的图片体积</p></li> <li><p>图片裁剪&amp;降质</p> <p>鉴于移动端的设备分辨率是有上限的，很多图片的尺寸常常远大于页面元素尺寸（图片尺寸2倍于页面尺寸），这非常浪费网络资源。</p></li> <li><p>图片懒加载、雪碧图优化</p></li> <li><p>降级加载图片</p> <p>先模糊后高清</p> <div class="language-html extra-class"><pre class="language-html"><code>//banner.wxml
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{url}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

//图片加载器
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span><span class="token style-attr language-css"><span class="token attr-name">
     <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">width</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span><span class="token property">display</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span>
     <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{preloadUrl}}<span class="token punctuation">&quot;</span></span>
     <span class="token attr-name">bindload</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>onImgLoad<span class="token punctuation">&quot;</span></span>
     <span class="token attr-name">binderror</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>onErrorLoad<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">/&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//banner.js</span>
<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>originUrl <span class="token operator">=</span> <span class="token string">'https://path/to/picture'</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token operator">:</span> <span class="token function">compress</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>originUrl<span class="token punctuation">)</span><span class="token punctuation">,</span>
            preloadUrl<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originUrl
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">onImgLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                url<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originUrl
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li> <li><p>骨架屏</p></li></ol> <h2 id="页面渲染慢"><a href="#页面渲染慢" class="header-anchor">#</a> 页面渲染慢</h2> <p>有效的渲染方向：</p> <ul><li>降低线程间通信频次</li> <li>减少线程间通信的数据量</li> <li>减少WXML节点数量</li></ul> <p>优化策略：</p> <ol><li><p>合并setData调用</p></li> <li><p>只把与界面渲染相关的数据放在data中</p></li> <li><p>应用层的数据diff</p> <p>在setData之前，把数据和之前的数据做对比，没有变化就不需要了。因为每一次setData都会导致data数据和WXML构建出新的节点树，和之前的节点树做比较，然后更新。</p></li> <li><p>去掉不必要的事件绑定</p> <p>逻辑层绑定了回调函数，就会触发通信过程。像OnPageScroll这种事件，频繁触发的，尽量避免。</p></li> <li><p>去掉不必要的节点属性</p> <p>节点属性越多，通信时间越长。</p></li> <li><p>适当的组件颗粒度</p> <p>适当的组件化可以减少数据更新时的影响范围，如倒计时组件。</p></li> <li><p><strong>事件总线，代替组件间数据绑定的通信方式</strong></p></li> <li><p>组件层面的diff</p> <p>渲染时如果新的数据是旧的数据的子集，且顺序不变，则把消失的位置置位none，而不是直接setData，降低试图渲染的压力。</p></li></ol> <h2 id="运行内存不足"><a href="#运行内存不足" class="header-anchor">#</a> 运行内存不足</h2> <p>优化策略：</p> <ol><li><p>内存预警</p> <p>做埋点，做日志监测</p></li> <li><p>回收后台页面计时器</p> <p>一个页面一个webview线程，但js线程只有一个。当页面处于onHide状态时，可以把耗费js线程资源的操作先清理掉，例如定时器（主要是里面的代码逻辑），然后在onShow的时候再恢复。</p></li> <li><p>避免频发事件中重度内存操作</p> <p>对于频发事件的监听，需要遵守的原则：</p> <ul><li>onPageScroll事件需要节流</li> <li>避免CPU密集型操作，譬如复杂的计算</li> <li>避免调用，实在要调用要较少setData的数据量</li> <li>尽量使用IntersectionObserver来替代SelectorQuery，前者对性能影响更小</li></ul></li> <li><p>大图、长列表优化</p> <p>对图片降质或者裁剪，当然不是最好的。</p> <p>瀑布流思路：利用intersectionObserver监听长列表内组件与视窗的相交关系，当组件距离视窗大于某个临界点时，销毁该组件释放内存，并用同等的骨架图占屏；当距离小于临界点时，再取缓存数据加载该组件。</p> <p>如果用户滑的很快，销毁后来不及加载，视觉上会出现白屏。我们可以适当调整销毁的时间点，或者优化骨架图样式来提升体验。</p> <p>小程序官方的长列表组件。</p></li></ol> <h2 id="小程序生命周期"><a href="#小程序生命周期" class="header-anchor">#</a> 小程序生命周期</h2> <p><img src="http://image.lanbling.com/md/page-lifecycle.2e646c86.png" alt="page-lifecycle.2e646c86"></p> <h2 id="原文链接"><a href="#原文链接" class="header-anchor">#</a> 原文链接</h2> <p><a href="https://aotu.io/notes/2020/03/25/high-performance-miniprogram/" target="_blank" rel="noopener noreferrer">如何打造高性能小程序门户<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/lanbling/document/edit/master/docs/experience/optimize/小程序性能优化.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">2020年7月14日星期二下午4点51分</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/experience/engineering/webpack进阶.html" class="prev">
        webpack进阶
      </a></span> <span class="next"><a href="/experience/optimize/H5视频播放踩坑.html">
        H5视频播放踩坑
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7432f3e5.js" defer></script><script src="/assets/js/2.5aced2d4.js" defer></script><script src="/assets/js/27.2a3cfa74.js" defer></script>
  </body>
</html>
